#!/bin/bash
set -e

clickhouse client -n <<-EOSQL

CREATE DATABASE IF NOT EXISTS pricemon;

CREATE TABLE IF NOT EXISTS pricemon.prices_kafka (
    timestamp UInt64,
    bid_01 Float32,
    bid_02 Float32,
    bid_03 Float32,
    bid_04 Float32,
    bid_05 Float32,
    bid_06 Float32,
    bid_07 Float32,
    bid_08 Float32,
    bid_09 Float32,
    bid_10 Float32,
    bid_11 Float32,
    bid_12 Float32,
    bid_13 Float32,
    bid_14 Float32,
    bid_15 Float32,
    bid_16 Float32,
    bid_17 Float32,
    bid_18 Float32,
    bid_19 Float32,
    bid_20 Float32,
    bid_21 Float32,
    bid_22 Float32,
    bid_23 Float32,
    bid_24 Float32,
    bid_25 Float32,
    bid_26 Float32,
    bid_27 Float32,
    bid_28 Float32,
    bid_29 Float32,
    bid_30 Float32,
    bid_31 Float32,
    bid_32 Float32,
    bid_33 Float32,
    bid_34 Float32,
    bid_35 Float32,
    bid_36 Float32,
    bid_37 Float32,
    bid_38 Float32,
    bid_39 Float32,
    bid_40 Float32,
    bid_41 Float32,
    bid_42 Float32,
    bid_43 Float32,
    bid_44 Float32,
    bid_45 Float32,
    bid_46 Float32,
    bid_47 Float32,
    bid_48 Float32,
    bid_49 Float32,
    bid_50 Float32,
    ask_01 Float32,
    ask_02 Float32,
    ask_03 Float32,
    ask_04 Float32,
    ask_05 Float32,
    ask_06 Float32,
    ask_07 Float32,
    ask_08 Float32,
    ask_09 Float32,
    ask_10 Float32,
    ask_11 Float32,
    ask_12 Float32,
    ask_13 Float32,
    ask_14 Float32,
    ask_15 Float32,
    ask_16 Float32,
    ask_17 Float32,
    ask_18 Float32,
    ask_19 Float32,
    ask_20 Float32,
    ask_21 Float32,
    ask_22 Float32,
    ask_23 Float32,
    ask_24 Float32,
    ask_25 Float32,
    ask_26 Float32,
    ask_27 Float32,
    ask_28 Float32,
    ask_29 Float32,
    ask_30 Float32,
    ask_31 Float32,
    ask_32 Float32,
    ask_33 Float32,
    ask_34 Float32,
    ask_35 Float32,
    ask_36 Float32,
    ask_37 Float32,
    ask_38 Float32,
    ask_39 Float32,
    ask_40 Float32,
    ask_41 Float32,
    ask_42 Float32,
    ask_43 Float32,
    ask_44 Float32,
    ask_45 Float32,
    ask_46 Float32,
    ask_47 Float32,
    ask_48 Float32,
    ask_49 Float32,
    ask_50 Float32,
    stats String
) ENGINE = Kafka SETTINGS
        kafka_broker_list = '172.16.100.11:9092',
        kafka_topic_list = 'prices',
        kafka_group_name = 'clickhouse',
        kafka_format = 'JSONEachRow';

CREATE TABLE IF NOT EXISTS pricemon.prices (
    timestamp UInt64,
    bid_01 Float32,
    bid_02 Float32,
    bid_03 Float32,
    bid_04 Float32,
    bid_05 Float32,
    bid_06 Float32,
    bid_07 Float32,
    bid_08 Float32,
    bid_09 Float32,
    bid_10 Float32,
    bid_11 Float32,
    bid_12 Float32,
    bid_13 Float32,
    bid_14 Float32,
    bid_15 Float32,
    bid_16 Float32,
    bid_17 Float32,
    bid_18 Float32,
    bid_19 Float32,
    bid_20 Float32,
    bid_21 Float32,
    bid_22 Float32,
    bid_23 Float32,
    bid_24 Float32,
    bid_25 Float32,
    bid_26 Float32,
    bid_27 Float32,
    bid_28 Float32,
    bid_29 Float32,
    bid_30 Float32,
    bid_31 Float32,
    bid_32 Float32,
    bid_33 Float32,
    bid_34 Float32,
    bid_35 Float32,
    bid_36 Float32,
    bid_37 Float32,
    bid_38 Float32,
    bid_39 Float32,
    bid_40 Float32,
    bid_41 Float32,
    bid_42 Float32,
    bid_43 Float32,
    bid_44 Float32,
    bid_45 Float32,
    bid_46 Float32,
    bid_47 Float32,
    bid_48 Float32,
    bid_49 Float32,
    bid_50 Float32,
    ask_01 Float32,
    ask_02 Float32,
    ask_03 Float32,
    ask_04 Float32,
    ask_05 Float32,
    ask_06 Float32,
    ask_07 Float32,
    ask_08 Float32,
    ask_09 Float32,
    ask_10 Float32,
    ask_11 Float32,
    ask_12 Float32,
    ask_13 Float32,
    ask_14 Float32,
    ask_15 Float32,
    ask_16 Float32,
    ask_17 Float32,
    ask_18 Float32,
    ask_19 Float32,
    ask_20 Float32,
    ask_21 Float32,
    ask_22 Float32,
    ask_23 Float32,
    ask_24 Float32,
    ask_25 Float32,
    ask_26 Float32,
    ask_27 Float32,
    ask_28 Float32,
    ask_29 Float32,
    ask_30 Float32,
    ask_31 Float32,
    ask_32 Float32,
    ask_33 Float32,
    ask_34 Float32,
    ask_35 Float32,
    ask_36 Float32,
    ask_37 Float32,
    ask_38 Float32,
    ask_39 Float32,
    ask_40 Float32,
    ask_41 Float32,
    ask_42 Float32,
    ask_43 Float32,
    ask_44 Float32,
    ask_45 Float32,
    ask_46 Float32,
    ask_47 Float32,
    ask_48 Float32,
    ask_49 Float32,
    ask_50 Float32,
    stats String

) ENGINE = MergeTree()
    ORDER BY timestamp;

CREATE MATERIALIZED VIEW IF NOT EXISTS pricemon.prices_view TO pricemon.prices AS
SELECT * FROM pricemon.prices_kafka;

EOSQL
